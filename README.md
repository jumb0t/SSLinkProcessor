# SSLinkProcessor

**SSLinkProcessor** - инструмент для обработки ссылок ShadowSocks (SS), позволяющий:

- **Декодировать** SS ссылки и извлекать конфигурационные данные.
- **Резолвить домены** серверов в IP-адреса.
- **Получать информацию об IP-адресах** серверов с помощью API [ipapi.co](https://ipapi.co/).
- **Асинхронно обрабатывать** множество ссылок с поддержкой ограничения одновременных запросов.
- **Логировать процесс** с цветовой подсветкой и разными уровнями детализации.
- **Выводить статистику** работы после завершения обработки.
- **Обрабатывать ошибки и исключения**, обеспечивая устойчивую работу.

## Содержание

- [Начало работы](#начало-работы)
  - [Требования](#требования)
  - [Установка](#установка)
- [Использование](#использование)
  - [Синтаксис команды](#синтаксис-команды)
  - [Параметры](#параметры)
  - [Примеры запуска](#примеры-запуска)
- [Описание кода](#описание-кода)
  - [Структура проекта](#структура-проекта)
  - [Основные компоненты](#основные-компоненты)
- [Дополнительные утилиты](#дополнительные-утилиты)
  - [Однострочный Bash скрипт для получения информации об IP-адресах](#однострочный-bash-скрипт-для-получения-информации-об-ip-адресах)
- [Обработка ошибок](#обработка-ошибок)
- [Логирование](#логирование)
- [Лицензия](#лицензия)

## Начало работы

### Требования

- **Python 3.7** или выше.
- Библиотеки Python:

  - `aiohttp`
  - `aiofiles`
  - `colorama`

### Установка

1. **Клонируйте репозиторий** или скачайте файл `ss_link_processor.py`.

   ```bash
   git clone https://github.com/yourusername/SSLinkProcessor.git
   ```

2. **Установите необходимые зависимости** с помощью `pip`.

   ```bash
   pip install -r requirements.txt
   ```

   Если файла `requirements.txt` нет, установите необходимые пакеты напрямую:

   ```bash
   pip install aiohttp aiofiles colorama
   ```

## Использование

### Синтаксис команды

```bash
python ss_link_processor.py [OPTIONS] <input_file> <output_file>
```

### Параметры

- **input_file**: Путь к файлу с SS ссылками (обязательный параметр).
- **output_file**: Путь к файлу для записи результатов (обязательный параметр).

**Опции:**

- `--concurrency`: Максимальное количество одновременных запросов (по умолчанию: 10).
- `--queue-size`: Размер очереди для записи результатов (по умолчанию: 100).
- `--log-level`: Уровень логирования (по умолчанию: INFO). Возможные значения: `DEBUG`, `INFO`, `WARNING`, `ERROR`, `CRITICAL`.
- `--log-file`: Путь к файлу для записи логов (по умолчанию: вывод в консоль).
- `--timeout`: Таймаут для HTTP-запросов в секундах (по умолчанию: 10).
- `--api-url`: URL API для получения информации об IP (по умолчанию: `https://ipapi.co/{ip}/json/`).
- `--encoding`: Кодировка файлов (по умолчанию: `utf-8`).
- `--decode-only`: Включить режим только декодирования без запросов к `ipapi.co`.
- `--ip`: Путь к файлу для записи IP-адресов (необязательный).

### Примеры запуска

1. **Декодирование ссылок с получением информации об IP и записью IP-адресов в файл:**

   ```bash
   python ss_link_processor.py input.txt output.txt --ip ip_addresses.txt
   ```

2. **Только декодирование ссылок без обращений к API:**

   ```bash
   python ss_link_processor.py input.txt output.txt --decode-only
   ```

3. **Увеличение количества одновременных запросов и запись логов в файл:**

   ```bash
   python ss_link_processor.py input.txt output.txt --concurrency 20 --log-file ss_processor.log
   ```

4. **Установка уровня логирования на DEBUG для подробной информации:**

   ```bash
   python ss_link_processor.py input.txt output.txt --log-level DEBUG
   ```

## Описание кода

### Структура проекта

- **`ss_link_processor.py`**: Основной файл скрипта, содержащий весь код и логику приложения.

### Основные компоненты

1. **Config**: Класс конфигурации, содержащий все настройки приложения. Позволяет легко управлять параметрами через аргументы командной строки.

   ```python
   @dataclass
   class Config:
       input_file: str
       output_file: str
       ...
   ```

2. **setup_logging**: Функция для настройки цветного логирования на основе конфигурации. Поддерживает вывод в консоль и файл.

   ```python
   def setup_logging(config: Config):
       ...
   ```

3. **SSUrlDecoder**: Класс для декодирования SS ссылок. Включает методы для проверки валидности и декодирования ссылок.

   ```python
   class SSUrlDecoder:
       @staticmethod
       def validate_ss_url(ss_url: str) -> bool:
           ...
       
       @staticmethod
       def decode_ss_url(ss_url: str) -> Dict[str, Any]:
           ...
   ```

4. **NetworkUtils**: Класс с сетевыми утилитами. Содержит методы для проверки IP-адресов и резолвинга доменов.

   ```python
   class NetworkUtils:
       @staticmethod
       def is_valid_ip(address: str) -> bool:
           ...
       
       @staticmethod
       def resolve_domain_to_ip(domain: str) -> Optional[str]:
           ...
   ```

5. **IPInfoFetcher**: Класс для получения информации об IP-адресах с помощью API `ipapi.co`. Обрабатывает ответы и возможные ошибки API.

   ```python
   class IPInfoFetcher:
       def __init__(self, config: Config):
           ...
       
       async def get_ip_info(self, ip_address: str) -> Dict[str, Any]:
           ...
   ```

6. **SSLinkProcessor**: Основной класс для обработки SS ссылок. Управляет процессом чтения, обработки и записи результатов.

   ```python
   class SSLinkProcessor:
       def __init__(self, config: Config):
           ...
       
       async def process_line(self, line: str, line_number: int):
           ...
       
       async def writer(self):
           ...
       
       async def process_file(self):
           ...
   ```

7. **main()**: Точка входа приложения. Обрабатывает аргументы командной строки, настраивает логирование и запускает процессор ссылок.

   ```python
   def main():
       ...
   ```

## Дополнительные утилиты

### Однострочный Bash скрипт для получения информации об IP-адресах

Если у вас есть файл с IP-адресами (например, `ip_addresses.txt`), и вы хотите получить информацию об этих IP-адресах с помощью API `ipapi.co`, вы можете использовать следующий однострочный Bash скрипт:

```bash
while read ip; do curl -s "https://ipapi.co/$ip/json/" >> ip_info.json; done < ip_addresses.txt
```

**Объяснение:**

- **`while read ip; do ...; done < ip_addresses.txt`**: Цикл читает каждый IP-адрес из файла `ip_addresses.txt`.
- **`curl -s "https://ipapi.co/$ip/json/"`**: Отправляет запрос к API `ipapi.co` для получения информации об IP-адресе.
- **`>> ip_info.json`**: Добавляет полученный JSON-ответ в файл `ip_info.json`.

**Примечания:**

- Убедитесь, что файл `ip_addresses.txt` содержит один IP-адрес на строку.
- Файл `ip_info.json` будет содержать информацию обо всех IP-адресах в формате JSON, записанную подряд.
- Если вы хотите, чтобы каждая запись была на отдельной строке, вы можете добавить перевод строки после каждого запроса:

  ```bash
  while read ip; do curl -s "https://ipapi.co/$ip/json/" >> ip_info.json; echo "" >> ip_info.json; done < ip_addresses.txt
  ```

**Важное замечание:**

- **Учитывайте ограничения API `ipapi.co`**: Без использования платного плана может быть ограничение на количество запросов в минуту или в день. Частые запросы могут привести к блокировке доступа. Рекомендуется проверить условия использования API перед массовым использованием.

## Обработка ошибок

Программа включает расширенную обработку ошибок и исключений:

- **Декодирование SS ссылок**: Обрабатываются ошибки неверного формата, отсутствия необходимых частей ссылки, ошибки декодирования Base64.
- **Сетевые ошибки**: Обработка таймаутов, ошибок соединения, недоступности DNS.
- **Ошибки API**: На основе документации `ipapi.co` обработаны различные коды ошибок HTTP (400, 403, 404, 405, 429). Программа выводит подробные сообщения об ошибках, полученных от API.
- **Общие исключения**: Ловятся и логируются все неожиданные исключения для предотвращения падения программы.

## Логирование

Логирование настраивается через параметры:

- **Уровень логирования**: Опция `--log-level` позволяет установить уровень детализации (`DEBUG`, `INFO`, `WARNING`, `ERROR`, `CRITICAL`).
- **Вывод логов в файл**: С помощью опции `--log-file` можно указать файл для записи логов.
- **Цветная подсветка**: Логи в консоли отображаются с цветовой подсветкой, соответствующей уровню сообщения.
  - `DEBUG`: Голубой
  - `INFO`: Зеленый
  - `WARNING`: Желтый
  - `ERROR`: Красный
  - `CRITICAL`: Магента
- **Формат сообщений**: Логи включают временную метку, уровень и сообщение, что облегчает отладку.

Пример настройки логирования:

```bash
python ss_link_processor.py input.txt output.txt --log-level DEBUG --log-file ss_processor.log
```

## Статистика работы

После завершения обработки программа выводит подробную статистику:

- Всего ссылок
- Успешно обработано ссылок
- Резолвлено доменов
- Получено IP-адресов
- Количество ошибок

Пример вывода статистики:

```
----------------------------------------
Статистика работы программы:
Всего ссылок: 100
Успешно обработано ссылок: 95
Резолвлено доменов: 50
Получено IP-адресов: 100
Количество ошибок: 5
----------------------------------------
```

## Лицензия

Этот проект распространяется под лицензией **MIT License**. Подробности см. в файле [LICENSE](LICENSE).

---

**Примечания:**

- При использовании данного инструмента убедитесь, что вы соблюдаете условия использования API [ipapi.co](https://ipapi.co/).
- Если вы планируете обрабатывать большое количество ссылок, учитывайте возможные ограничения по количеству запросов к API.
- Заголовки HTTP запросов были настроены для имитации реального браузера с целью улучшения совместимости с API.
- **Цветное логирование** делает вывод более информативным и удобным для чтения.

**Контакты для обратной связи:**

- Автор: *Ваше имя*
- Email: *ваш_email@example.com*
- GitHub: [yourusername](https://github.com/yourusername)

---

**Пример файла `requirements.txt`:**

```
aiohttp
aiofiles
colorama
```

**Советы:**

- **Обновление зависимостей:** Убедитесь, что у вас установлены последние версии зависимостей.
- **Запуск в виртуальном окружении:** Рекомендуется использовать виртуальное окружение для установки зависимостей, чтобы избежать конфликтов с другими проектами.
- **Отладка:** Используйте уровень логирования `DEBUG` для получения подробной информации во время отладки.

---

**Спасибо за использование SSLinkProcessor!**